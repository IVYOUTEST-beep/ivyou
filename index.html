<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>
    <title>IVYOU AR</title>

    <style>
      body { margin: 0; overflow: hidden; font-family: 'Arial', sans-serif; background-color: black; }
      
      /* --- EKRAN ≈ÅADOWANIA --- */
      #loader-screen {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: black; z-index: 99999;
        display: flex; flex-direction: column; justify-content: center; align-items: center;
        transition: opacity 0.5s;
      }
      .pulsing-logo { width: 100px; animation: breathe 2s infinite; }
      @keyframes breathe { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.1); opacity: 0.8; } 100% { transform: scale(1); opacity: 1; } }
      #loader-text { margin-top: 20px; color: #D4AF37; font-weight: bold; letter-spacing: 2px; }

      /* --- CZYSTY UI (Bez zas≈Çaniania kamery) --- */
      #ui-layer { 
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
        z-index: 9999; pointer-events: none; 
        display: flex; flex-direction: column; align-items: center; 
      }

      /* RAMKA - TERAZ CA≈ÅKOWICIE PRZEZROCZYSTA W ≈öRODKU */
      .scan-frame {
        position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
        width: 70vw; height: 70vw;
        border: 2px solid rgba(212, 175, 55, 0.8); /* Tylko z≈Çota linia */
        border-radius: 20px;
        /* ZERO cienia, ZERO t≈Ça - kamera bƒôdzie widoczna w 100% */
      }
      
      /* Ozdobne rogi (opcjonalne, dla stylu) */
      .scan-frame::before { content: ''; position: absolute; top: -5px; left: -5px; width: 20px; height: 20px; border-top: 5px solid #D4AF37; border-left: 5px solid #D4AF37; border-top-left-radius: 20px; }
      .scan-frame::after { content: ''; position: absolute; bottom: -5px; right: -5px; width: 20px; height: 20px; border-bottom: 5px solid #D4AF37; border-right: 5px solid #D4AF37; border-bottom-right-radius: 20px; }

      .logo-img { margin-top: 40px; height: 60px; filter: drop-shadow(0 2px 4px black); }
      .instruction { 
        position: absolute; bottom: 15%; 
        color: #D4AF37; font-size: 14px; font-weight: bold; letter-spacing: 1px;
        text-shadow: 1px 1px 2px black; text-align: center; width: 100%;
      }

      /* PRZYCISKI */
      #unmuteButton {
        position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); z-index: 10001;
        background: #D4AF37; color: black; border: none; padding: 12px 30px; 
        border-radius: 30px; font-weight: bold; cursor: pointer; display: none; pointer-events: auto;
      }
      #websiteButton {
        position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%); z-index: 10002;
        color: #D4AF37; text-decoration: none; border: 1px solid #D4AF37; 
        padding: 10px 25px; border-radius: 30px; font-size: 12px; pointer-events: auto; background: rgba(0,0,0,0.5);
      }
      
      /* Ukrywamy wideo systemowe (to poza AR) */
      #vid-hidden { position: absolute; top: -10000px; }
      .a-enter-vr-button { display: none; }
    </style>
  </head>
  <body>

    <div id="loader-screen">
        <img src="./logo.png" class="pulsing-logo" onerror="this.style.display='none';">
        <div id="loader-text">≈ÅADOWANIE...</div>
    </div>

    <div id="ui-layer" style="display:none;">
      <img src="./logo.png" class="logo-img" onerror="this.style.display='none';">
      <div id="scan-guide" class="scan-frame"></div>
      <div id="scan-text" class="instruction">SKIERUJ KAMERƒò NA ZDJƒòCIE</div>
    </div>

    <button id="unmuteButton">üîä W≈ÅƒÑCZ D≈πWIƒòK</button>
    <a href="https://ivyou.pl" target="_blank" id="websiteButton" style="display:none;">IVYOU.PL</a>

    <div id="ar-container"></div>

    <script>
      // === KONFIGURACJA ===
      const MAX_SLOTS = 20; 
      const urlParams = new URLSearchParams(window.location.search);
      const klientID = urlParams.get('k');

      if (!klientID) {
          alert("B≈ÅƒÑD: Brak folderu w linku (?k=...)");
          throw new Error("Brak ID");
      }

      const folder = `./ivyou/${klientID}`;
      const mindFile = `${folder}/targets.mind`;

      function startApp() {
          console.log("Uruchamianie dla: " + folder);

          // BUDOWANIE SCENY
          // WA≈ªNE: Dodano 'targetIndex' i pƒôtlƒô generujƒÖcƒÖ
          let html = `<a-scene mindar-image="imageTargetSrc: ${mindFile}; maxTrack: 1; filterMinCF:0.0001; filterBeta: 0.001" color-space="sRGB" renderer="colorManagement: true, physicallyCorrectLights" vr-mode-ui="enabled: false" device-orientation-permission-ui="enabled: false">`;
          
          html += `<a-assets>`;
          for(let i=0; i < MAX_SLOTS; i++) {
              // playsinline jest kluczowe dla iPhone'√≥w
              html += `<video id="vid${i}" src="${folder}/${i}.mp4" loop="true" crossorigin="anonymous" playsinline webkit-playsinline muted autoplay></video>`;
          }
          html += `</a-assets>`;
          
          html += `<a-camera position="0 0 0" look-controls="enabled: false"></a-camera>`;

          for(let i=0; i < MAX_SLOTS; i++) {
              // --- NAJWA≈ªNIEJSZA ZMIANA ---
              // material="shader: flat" -> To naprawia "czarne wideo" (niewidzialne).
              // width="1" height="1" -> Domy≈õlny rozmiar (zabezpieczenie).
              html += `
              <a-entity mindar-image-target="targetIndex: ${i}" class="target-entity" data-id="${i}">
                  <a-plane id="plane${i}" src="#vid${i}" position="0 0 0" height="1" width="1" rotation="0 0 0" material="shader: flat; opacity: 1;"></a-plane>
              </a-entity>`;
          }
          html += `</a-scene>`;

          document.getElementById('ar-container').innerHTML = html;

          // SKALOWANIE WIDEO (Auto-Fit)
          for(let i=0; i < MAX_SLOTS; i++) {
              const videoEl = document.getElementById(`vid${i}`);
              const planeEl = document.getElementById(`plane${i}`);
              
              if(videoEl) {
                  videoEl.addEventListener('loadedmetadata', () => {
                      // Je≈õli wideo ma wymiary, dopasuj AR
                      if(videoEl.videoWidth > 0 && videoEl.videoHeight > 0) {
                          const ratio = videoEl.videoHeight / videoEl.videoWidth;
                          planeEl.setAttribute("height", ratio);
                          planeEl.setAttribute("width", 1);
                      }
                  });
              }
          }

          // UKRYJ LOADER PO 3 SEKUNDACH
          setTimeout(() => {
              document.getElementById('loader-screen').style.opacity = '0';
              setTimeout(() => {
                  document.getElementById('loader-screen').style.display = 'none';
                  document.getElementById('ui-layer').style.display = 'flex';
                  document.getElementById('websiteButton').style.display = 'flex';
              }, 500);
              initEvents();
          }, 2500);
      }

      function initEvents() {
          const unmuteBtn = document.querySelector("#unmuteButton");
          const scanGuide = document.querySelector("#scan-guide");
          const scanText = document.querySelector("#scan-text");
          const targets = document.querySelectorAll('.target-entity');

          targets.forEach(target => {
              target.addEventListener("targetFound", event => {
                  console.log("Wykryto cel!");
                  const id = target.getAttribute('data-id');
                  const video = document.querySelector(`#vid${id}`);
                  const plane = document.querySelector(`#plane${id}`);

                  if(video) {
                      video.play();
                      // Upewniamy siƒô, ≈ºe wideo jest g≈Ço≈õne
                      // (U≈ºytkownik musi kliknƒÖƒá przycisk, ≈ºeby odblokowaƒá d≈∫wiƒôk w przeglƒÖdarce)
                      
                      // Dopasowanie awaryjne (je≈õli loadedmetadata nie zadzia≈Ça≈Ço wcze≈õniej)
                      if(plane && video.videoWidth > 0) {
                          const ratio = video.videoHeight / video.videoWidth;
                          plane.setAttribute("height", ratio);
                      }

                      unmuteBtn.style.display = "block";
                      scanGuide.style.display = "none";
                      scanText.style.display = "none";
                  }
              });

              target.addEventListener("targetLost", event => {
                  console.log("Zgubiono cel");
                  const id = target.getAttribute('data-id');
                  const video = document.querySelector(`#vid${id}`);
                  if(video) video.pause();

                  unmuteBtn.style.display = "none";
                  scanGuide.style.display = "block";
                  scanText.style.display = "block";
              });
          });

          // OBS≈ÅUGA D≈πWIƒòKU
          unmuteBtn.addEventListener("click", () => {
              document.querySelectorAll('video').forEach(v => {
                  v.muted = false;
                  v.volume = 1.0;
              });
              unmuteBtn.innerText = "S≈ÅUCHASZ IVYOU";
              unmuteBtn.style.background = "#2ecc71"; // Zielony
              setTimeout(() => { unmuteBtn.style.display = "none"; }, 2000);
          });
      }

      // START
      startApp();
    </script>
  </body>
</html>
