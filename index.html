<!DOCTYPE html>
<html lang="pl">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <title>IVYOU AR</title>

    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>

    <script>
      // --- MAGIA: SHADER WTAPIAJĄCY (Magic Blend) ---
      // Ten kod sprawia, że krawędzie wideo stają się miękkie i przezroczyste.
      AFRAME.registerShader('magic-blend', {
        schema: {
          src: {type: 'map', is: 'uniform'},
          opacity: {type: 'number', is: 'uniform', default: 1.0}
        },
        vertexShader: `
          varying vec2 vUV;
          void main() {
            vUV = uv;
            gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
          }
        `,
        fragmentShader: `
          uniform sampler2D src;
          uniform float opacity;
          varying vec2 vUV;
          void main() {
            vec4 color = texture2D(src, vUV);
            // Obliczanie miękkości krawędzi (0.15 = szerokie, miękkie przejście)
            float edgeWidth = 0.15; 
            float alphaX = smoothstep(0.0, edgeWidth, vUV.x) * smoothstep(1.0, 1.0 - edgeWidth, vUV.x);
            float alphaY = smoothstep(0.0, edgeWidth, vUV.y) * smoothstep(1.0, 1.0 - edgeWidth, vUV.y);
            
            // Mnożymy oryginalną przezroczystość przez naszą maskę krawędzi
            gl_FragColor = vec4(color.rgb, color.a * opacity * alphaX * alphaY);
          }
        `
      });
    </script>

    <style>
      /* --- FUNDAMENTY --- */
      html, body {
        margin: 0; padding: 0; width: 100%; height: 100%;
        background-color: black !important;
        overflow: hidden; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
      }

      /* Kamera AR - Overscan */
      video {
        position: absolute !important;
        top: 50% !important; left: 50% !important;
        transform: translate(-50%, -50%) !important;
        min-width: 102vw !important; min-height: 102vh !important;
        width: auto !important; height: auto !important;
        object-fit: cover !important;
        z-index: -2 !important; display: block !important;
      }

      #ar-container {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        z-index: 1; background: transparent !important;
      }
      
      .a-enter-vr-button { display: none; }

      /* --- EKRAN STARTOWY (PREMIUM) --- */
      #start-screen {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        z-index: 99999;
        display: flex; flex-direction: column; justify-content: center; align-items: center;
        background: radial-gradient(circle at center, #1a1a1a 0%, #000000 100%);
      }
      
      .logo-start { 
        width: 180px; margin-bottom: 60px; 
        filter: drop-shadow(0 0 15px rgba(212, 175, 55, 0.3));
        animation: floatLogo 3s ease-in-out infinite;
      }

      /* Złoty Przycisk */
      #start-btn {
        padding: 18px 50px; 
        font-size: 16px; font-weight: 700;
        background-image: linear-gradient(to right, #8E6E26 0%, #F4D03F  51%, #8E6E26  100%);
        background-size: 200% auto;
        color: black; 
        border: 1px solid #F4D03F; border-radius: 50px;
        cursor: pointer; text-transform: uppercase; letter-spacing: 3px;
        box-shadow: 0 0 20px rgba(212, 175, 55, 0.4);
        transition: 0.5s;
        animation: pulseButton 2s infinite;
      }
      #start-btn:active { transform: scale(0.95); }

      /* --- UI SKANERA --- */
      #ui-layer {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        z-index: 10; pointer-events: none;
        display: none;
        flex-direction: column; align-items: center; justify-content: space-between;
        padding: 40px 0;
        transition: opacity 0.5s ease;
      }

      .logo-top { width: 90px; filter: drop-shadow(0 2px 4px black); opacity: 0.9; margin-top: 10px; }

      .scanner-frame { position: relative; width: 70vw; height: 70vw; }
      .corner {
        position: absolute; width: 30px; height: 30px;
        border-color: #D4AF37; border-style: solid; opacity: 0.9;
        filter: drop-shadow(0 0 8px rgba(212, 175, 55, 0.6));
      }
      .tl { top: 0; left: 0; border-width: 4px 0 0 4px; border-top-left-radius: 15px; }
      .tr { top: 0; right: 0; border-width: 4px 4px 0 0; border-top-right-radius: 15px; }
      .bl { bottom: 0; left: 0; border-width: 0 0 4px 4px; border-bottom-left-radius: 15px; }
      .br { bottom: 0; right: 0; border-width: 0 4px 4px 0; border-bottom-right-radius: 15px; }

      .instruction-container {
        text-align: center; margin-bottom: 30px;
        display: flex; flex-direction: column; gap: 15px; align-items: center;
      }

      .instruction-text {
        color: #D4AF37; background: rgba(0,0,0,0.8);
        padding: 12px 35px; border-radius: 30px; font-size: 12px; font-weight: bold;
        text-transform: uppercase; border: 1px solid rgba(212, 175, 55, 0.5);
        letter-spacing: 2px;
      }

      #website-link {
        pointer-events: auto; color: #D4AF37; text-decoration: none; 
        border: 1px solid #D4AF37; padding: 10px 25px; border-radius: 25px; 
        font-size: 10px; background: rgba(0,0,0,0.9); letter-spacing: 1px;
      }

      @keyframes floatLogo { 0% { transform: translateY(0px); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0px); } }
      @keyframes pulseButton { 0% { box-shadow: 0 0 20px rgba(212, 175, 55, 0.4); } 50% { box-shadow: 0 0 35px rgba(212, 175, 55, 0.7); } 100% { box-shadow: 0 0 20px rgba(212, 175, 55, 0.4); } }
    </style>
  </head>
  <body>

    <div id="start-screen">
      <img src="./logo.png" class="logo-start" onerror="this.style.display='none'">
      <button id="start-btn">Ożyw Wspomnienie</button>
    </div>

    <div id="ui-layer">
        <img src="./logo.png" class="logo-top" onerror="this.style.display='none'">
        <div class="scanner-frame">
            <div class="corner tl"></div><div class="corner tr"></div>
            <div class="corner bl"></div><div class="corner br"></div>
        </div>
        <div class="instruction-container">
            <div class="instruction-text">Skieruj aparat na zdjęcie</div>
            <a href="https://ivyou.pl" target="_blank" id="website-link">IVYOU.PL</a>
        </div>
    </div>

    <div id="ar-container"></div>

    <script>
      const MAX_SLOTS = 20; 
      const params = new URLSearchParams(window.location.search);
      const folderName = params.get('k');

      if (!folderName) { alert("BŁĄD: Brak folderu w linku!"); throw new Error("Stop"); }

      const basePath = `./ivyou/${folderName}`;
      const mindPath = `${basePath}/targets.mind`;

      document.getElementById('start-btn').addEventListener('click', () => {
          document.getElementById('start-screen').style.display = 'none';
          document.getElementById('ui-layer').style.display = 'flex';
          initAR();
      });

      function initAR() {
          const container = document.getElementById('ar-container');
          
          let html = `
            <a-scene 
              mindar-image="imageTargetSrc: ${mindPath}; maxTrack: 1; filterMinCF:0.0001; filterBeta: 0.001; uiLoading:no; uiScanning:no; uiError:no;" 
              color-space="sRGB" 
              renderer="colorManagement: true, physicallyCorrectLights; alpha: true;" 
              vr-mode-ui="enabled: false" 
              device-orientation-permission-ui="enabled: false">
              
              <a-assets>`;

          for(let i=0; i<MAX_SLOTS; i++) {
              html += `<video id="vid${i}" src="${basePath}/${i}.mp4" loop="true" playsinline webkit-playsinline crossorigin="anonymous"></video>`;
          }

          html += `</a-assets>
                   <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>`;

          for(let i=0; i<MAX_SLOTS; i++) {
              // UŻYWAMY NOWEGO SHADERA: magic-blend
              html += `
              <a-entity mindar-image-target="targetIndex: ${i}" class="target-marker" data-id="${i}">
                  <a-plane id="plane${i}" src="#vid${i}" position="0 0 0" height="1" width="1" rotation="0 0 0" 
                    material="shader: magic-blend; opacity: 1; transparent: true;">
                  </a-plane>
              </a-entity>`;
          }

          html += `</a-scene>`;
          container.innerHTML = html;

          setTimeout(() => {
              document.body.style.background = 'transparent'; 
              const scene = document.querySelector('a-scene');
              if(scene && scene.renderer) scene.renderer.setClearColor(0, 0); 
              setupEvents();
          }, 1500);
      }

      function setupEvents() {
          const targets = document.querySelectorAll('.target-marker');
          const uiLayer = document.getElementById('ui-layer');
          
          targets.forEach((target, index) => {
              target.addEventListener('targetFound', () => {
                  const vid = document.getElementById(`vid${index}`);
                  const plane = document.getElementById(`plane${index}`);
                  if(vid) {
                      vid.play();
                      vid.muted = false; 

                      uiLayer.style.opacity = '0';
                      
                      // POWIĘKSZENIE 1.35x + MAGIC BLEND = WOW!
                      const SCALE_FACTOR = 1.35; 
                      plane.setAttribute("width", SCALE_FACTOR);

                      if(vid.videoWidth > 0) {
                          const ratio = (vid.videoHeight / vid.videoWidth) * SCALE_FACTOR;
                          plane.setAttribute("height", ratio);
                      } else {
                          vid.addEventListener('loadedmetadata', () => {
                             const ratio = (vid.videoHeight / vid.videoWidth) * SCALE_FACTOR;
                             plane.setAttribute("height", ratio);
                          });
                      }
                  }
              });
              
              target.addEventListener('targetLost', () => {
                  const vid = document.getElementById(`vid${index}`);
                  if(vid) vid.pause();
                  uiLayer.style.opacity = '1';
              });
          });
      }
    </script>
  </body>
</html>

