<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>
    <title>IVYOU - Luxury AR</title>

    <style>
      body { margin: 0; overflow: hidden; font-family: 'Helvetica Neue', Arial, sans-serif; background-color: black; }
      
      /* --- EKRAN ADOWANIA --- */
      #loader-screen {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: black; z-index: 99999;
        display: flex; flex-direction: column; justify-content: center; align-items: center;
        transition: opacity 1s ease-out;
      }
      
      .pulsing-logo {
        width: 120px; 
        animation: breathe 2s infinite ease-in-out;
        filter: drop-shadow(0 0 15px rgba(212, 175, 55, 0.6));
      }
      @keyframes breathe {
        0% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.1); opacity: 0.8; } 
        100% { transform: scale(1); opacity: 1; }
      }

      #loader-text {
        margin-top: 25px; color: #D4AF37; font-size: 14px; letter-spacing: 5px; text-transform: uppercase; font-weight: bold;
      }

      /* --- UI APLIKACJI --- */
      #ui-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999; pointer-events: none; display: flex; flex-direction: column; align-items: center; }
      #vid { position: absolute; top: -10000px; visibility: hidden; }

      .scan-frame-mask { 
        position: absolute; top: 45%; left: 50%; transform: translate(-50%, -50%); 
        width: 70vw; height: 70vw; 
        border: 2px solid rgba(212, 175, 55, 0.9); 
        border-radius: 20px; 
        box-shadow: 0 0 0 100vmax rgba(0, 0, 0, 0.85); 
      }
      .logo-container { margin-top: 50px; z-index: 10000; }
      .logo-img { height: 80px; display: block; filter: drop-shadow(0 5px 10px black); }
      #fallback-logo { font-size: 30px; font-weight: 900; color: #D4AF37; letter-spacing: 5px; text-shadow: 2px 2px 10px black; }
      
      .instruction { 
        position: absolute; top: 75%; color: #FDCF58; font-size: 13px; 
        text-transform: uppercase; letter-spacing: 3px; font-weight: 600; 
        text-shadow: 0px 2px 5px black; z-index: 10000; text-align: center;
      }

      /* PRZYCISKI */
      #unmuteButton { 
        position: fixed; bottom: 140px; left: 50%; transform: translateX(-50%); z-index: 10001; 
        background: linear-gradient(135deg, #D4AF37, #B49228); 
        color: white; font-weight: 800; border: none; padding: 15px 40px; 
        border-radius: 50px; font-size: 14px; cursor: pointer; display: none; pointer-events: auto; 
        box-shadow: 0 10px 30px rgba(212, 175, 55, 0.4); text-transform: uppercase; letter-spacing: 1px;
      }
      #websiteButton { 
        position: fixed; bottom: 60px; left: 50%; transform: translateX(-50%); z-index: 10002; 
        text-decoration: none; border: 1px solid #D4AF37; color: #D4AF37; 
        padding: 12px 30px; border-radius: 30px; font-size: 12px; 
        letter-spacing: 2px; font-weight: bold; pointer-events: auto; background: rgba(0,0,0,0.8);
      }
      .a-enter-vr-button { display: none; }
    </style>
  </head>
  <body>

    <div id="loader-screen">
        <img src="./logo.png" class="pulsing-logo" onerror="this.style.display='none';">
        <div id="loader-text">IVYOU AR</div>
    </div>

    <div id="ui-layer" style="display:none;">
      <div class="logo-container">
        <img src="./logo.png" class="logo-img" alt="IVYOU" onerror="this.style.display='none'; document.getElementById('fallback-logo').style.display='block';">
        <div id="fallback-logo" style="display:none;">IVYOU</div>
      </div>
      <div id="scan-guide" class="scan-frame-mask"></div>
      <div id="scan-text" class="instruction">Skieruj kamer na zdjcie</div>
    </div>
    
    <button id="unmuteButton"> Wcz D藕wik</button>
    <a href="https://ivyou.pl" target="_blank" id="websiteButton" style="display:none;">IVYOU.PL</a>

    <div id="ar-container"></div>

    <script>
      // ==========================================
      // GWNA KONFIGURACJA
      // ==========================================
      
      // Zwikszylimy limit do 20. 
      // Kod przygotuje miejsce na filmy od 0.mp4 do 19.mp4.
      const MAX_SLOTS = 20; 

      const urlParams = new URLSearchParams(window.location.search);
      const klientID = urlParams.get('k');

      // Obsuga bdu linku
      if (!klientID) {
          document.getElementById('loader-text').innerText = "BD LINKU";
          document.getElementById('loader-text').style.color = "red";
          alert("Nie podae nazwy folderu w linku! (?k=...)");
          throw new Error("Brak ID");
      }

      // cie偶ki
      const folder = `./ivyou/${klientID}`;
      const mindFile = `${folder}/targets.mind`;

      // 2. FUNKCJA STARTUJCA
      function startApp() {
          console.log("Start aplikacji dla folderu: " + folder);
          console.log("Przygotowano slot贸w: " + MAX_SLOTS);
          
          let html = `<a-scene mindar-image="imageTargetSrc: ${mindFile}; maxTrack: 1; filterMinCF:0.0001; filterBeta: 0.001" color-space="sRGB" renderer="colorManagement: true, physicallyCorrectLights" vr-mode-ui="enabled: false" device-orientation-permission-ui="enabled: false">`;
          
          html += `<a-assets>`;
          // Generujemy 20 slot贸w wideo "w ciemno"
          for(let i=0; i < MAX_SLOTS; i++) {
              html += `<video id="vid${i}" src="${folder}/${i}.mp4" loop="true" crossorigin="anonymous" playsinline webkit-playsinline muted autoplay></video>`;
          }
          html += `</a-assets>`;
          
          html += `<a-camera position="0 0 0" look-controls="enabled: false"></a-camera>`;

          // Generujemy 20 cel贸w "w ciemno"
          for(let i=0; i < MAX_SLOTS; i++) {
              html += `
              <a-entity mindar-image-target="targetIndex: ${i}" class="target-entity" data-id="${i}">
                  <a-plane id="plane${i}" src="#vid${i}" position="0 0 0" height="1" width="1" rotation="0 0 0" opacity="0"></a-plane>
              </a-entity>`;
          }
          html += `</a-scene>`;

          // Wstrzykujemy scen
          document.getElementById('ar-container').innerHTML = html;

          // 3. INTELIGENTNE SKALOWANIE (Auto-Fit)
          for(let i=0; i < MAX_SLOTS; i++) {
              const videoEl = document.getElementById(`vid${i}`);
              const planeEl = document.getElementById(`plane${i}`);
              if(videoEl) {
                  // Gdy wideo si zaaduje, dopasuj wymiary
                  videoEl.addEventListener('loadedmetadata', () => {
                      const vW = videoEl.videoWidth;
                      const vH = videoEl.videoHeight;
                      if(vW > 0 && vH > 0) {
                          const ratio = vH / vW;
                          planeEl.setAttribute("height", ratio);
                          planeEl.setAttribute("width", 1);
                          console.log(`Zaadowano wideo ${i}: ${vW}x${vH}`);
                      }
                  });
                  // Ignorujemy bdy (np. 404 dla pustych slot贸w)
                  videoEl.addEventListener('error', () => {
                      // To jest normalne, 偶e sloty 5, 6... 19 bd zgasza bd, jeli nie ma plik贸w
                  });
              }
          }

          // 4. UKRYWANIE EKRANU ADOWANIA (Po 2.5 sekundach)
          setTimeout(() => {
              const loader = document.getElementById('loader-screen');
              loader.style.opacity = "0";
              setTimeout(() => { 
                  loader.style.display = 'none'; 
                  document.getElementById('ui-layer').style.display = 'flex';
                  document.getElementById('websiteButton').style.display = 'flex';
              }, 1000);
              
              initEvents();
          }, 2500); 
      }

      function initEvents() {
          const unmuteBtn = document.querySelector("#unmuteButton");
          const scanGuide = document.querySelector("#scan-guide");
          const scanText = document.querySelector("#scan-text");
          const targets = document.querySelectorAll('.target-entity');
              
          targets.forEach(target => {
            target.addEventListener("targetFound", event => {
              const id = target.getAttribute('data-id');
              const video = document.querySelector(`#vid${id}`);
              const plane = document.querySelector(`#plane${id}`);
              
              // Sprawdzamy, czy wideo istnieje i jest gotowe
              if(video && video.readyState > 0) { 
                  video.play();
                  if(plane) plane.setAttribute("animation", "property: opacity; to: 1; dur: 800; easing: easeOutQuad");
                  
                  unmuteBtn.style.display = "block";
                  scanGuide.style.opacity = "0";
                  scanText.style.opacity = "0";
              }
            });

            target.addEventListener("targetLost", event => {
              const id = target.getAttribute('data-id');
              const video = document.querySelector(`#vid${id}`);
              const plane = document.querySelector(`#plane${id}`);
              
              if(video) video.pause();
              if(plane) plane.setAttribute("opacity", "0"); 

              unmuteBtn.style.display = "none";
              scanGuide.style.opacity = "1";
              scanText.style.opacity = "1";
            });
          });

          unmuteBtn.addEventListener("click", () => {
            document.querySelectorAll('video').forEach(v => { v.muted = false; v.volume = 1.0; });
            unmuteBtn.innerText = "Suchasz IVYOU";
            unmuteBtn.style.background = "#27ae60";
            setTimeout(() => { unmuteBtn.style.display = "none"; }, 2000);
          });
      }

      // START
      startApp();

    </script>
  </body>
</html>
