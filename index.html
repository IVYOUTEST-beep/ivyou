<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>
    <title>IVYOU AR - Auto Detect</title>

    <style>
      body { margin: 0; overflow: hidden; font-family: 'Arial', sans-serif; background-color: black; }
      
      /* EKRAN ADOWANIA (Widoczny podczas skanowania) */
      #loader-screen {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: black; z-index: 99999;
        display: flex; flex-direction: column; justify-content: center; align-items: center;
        color: #D4AF37;
      }
      .spinner {
        width: 50px; height: 50px; border: 5px solid #333; border-top: 5px solid #D4AF37; border-radius: 50%;
        animation: spin 1s linear infinite; margin-bottom: 20px;
      }
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

      /* Reszta styl贸w bez zmian */
      #vid { position: absolute; top: -10000px; visibility: hidden; }
      #ui-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999; pointer-events: none; display: flex; flex-direction: column; align-items: center; }
      .scan-frame-mask { position: absolute; top: 45%; left: 50%; transform: translate(-50%, -50%); width: 65vw; height: 65vw; border: 3px solid #D4AF37; border-radius: 12px; box-shadow: 0 0 0 100vmax rgba(10, 8, 3, 0.85); }
      .logo-container { margin-top: 40px; z-index: 10000; }
      .logo-img { height: 70px; display: block; filter: drop-shadow(0 4px 8px rgba(0,0,0,0.9)); }
      #fallback-logo { font-size: 30px; font-weight: 900; color: #D4AF37; letter-spacing: 5px; text-shadow: 2px 2px 10px black; }
      .instruction { position: absolute; top: 70%; color: #D4AF37; font-size: 16px; text-transform: uppercase; letter-spacing: 4px; font-weight: bold; text-shadow: 1px 1px 5px black; z-index: 10000; text-align: center; }
      #unmuteButton { position: fixed; bottom: 140px; left: 50%; transform: translateX(-50%); z-index: 10001; background: linear-gradient(135deg, #D4AF37 0%, #FDCF58 100%); color: black; font-weight: 900; border: none; padding: 15px 50px; border-radius: 50px; font-size: 16px; cursor: pointer; display: none; pointer-events: auto; box-shadow: 0 10px 25px rgba(212, 175, 55, 0.4); }
      #websiteButton { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); z-index: 10002; text-decoration: none; background-color: rgba(0, 0, 0, 0.6); border: 1px solid #D4AF37; color: #D4AF37; padding: 12px 25px; border-radius: 30px; font-size: 14px; letter-spacing: 2px; font-weight: bold; pointer-events: auto; display: flex; align-items: center; gap: 10px; }
      .a-enter-vr-button { display: none; }
    </style>
  </head>
  <body>

    <div id="loader-screen">
        <div class="spinner"></div>
        <div id="loader-text">Szukam magii...</div>
    </div>

    <div id="ui-layer" style="display:none;"> <div class="logo-container">
        <img src="./logo.png" class="logo-img" alt="IVYOU AR" onerror="this.style.display='none'; document.getElementById('fallback-logo').style.display='block';">
        <div id="fallback-logo" style="display:none;">IVYOU</div>
      </div>
      <div id="scan-guide" class="scan-frame-mask"></div>
      <div id="scan-text" class="instruction">Skieruj wizjer na zdjcie</div>
    </div>
    <button id="unmuteButton"> ODBLOKUJ D殴WIK</button>
    <a href="https://ivyou.pl" target="_blank" id="websiteButton" style="display:none;">IVYOU.PL</a>

    <div id="ar-container"></div>

    <script>
      // --- KROK 1: Konfiguracja ---
      const urlParams = new URLSearchParams(window.location.search);
      const klientID = urlParams.get('k');

      if (!klientID) {
          document.getElementById('loader-text').innerText = "BD: Brak nazwy folderu w linku (?k=...)";
          document.querySelector('.spinner').style.borderTopColor = "red";
          throw new Error("Stop");
      }

      const folder = `./ivyou/${klientID}`;
      const mindFile = `${folder}/targets.mind`;

      // --- KROK 2: Detektyw Plik贸w (Funkcja Async) ---
      async function wykryjPlikiIStartuj() {
          const maxFilesToCheck = 50; // Maksymalnie sprawdzimy 50 plik贸w, 偶eby nie zwiesi przegldarki
          let znalezionePliki = 0;
          const loaderText = document.getElementById('loader-text');

          console.log("Rozpoczynam skanowanie plik贸w w: " + folder);

          // Ptla sprawdzajca pliki po kolei: 0.mp4, 1.mp4...
          for (let i = 0; i < maxFilesToCheck; i++) {
              loaderText.innerText = `Skanuj plik: ${i}.mp4...`;
              try {
                  // "Pingujemy" plik (metoda HEAD pobiera tylko nag贸wki, jest super szybka)
                  const response = await fetch(`${folder}/${i}.mp4`, { method: 'HEAD' });
                  
                  if (response.ok) {
                      znalezionePliki++;
                      console.log(`Znaleziono: ${i}.mp4`);
                  } else {
                      // Jeli trafimy na bd (np. 404), przerywamy ptl. Koniec albumu.
                      console.log(`Nie znaleziono: ${i}.mp4. Koniec skanowania.`);
                      break; 
                  }
              } catch (e) {
                  console.log("Bd sieci przy pliku " + i);
                  break;
              }
          }

          if (znalezionePliki === 0) {
              loaderText.innerText = "BD: Nie znaleziono 偶adnych film贸w (0.mp4) w folderze!";
              document.querySelector('.spinner').style.borderTopColor = "red";
              return;
          }

          console.log(`Zakoczono. Razem film贸w: ${znalezionePliki}`);
          loaderText.innerText = "adowanie silnika AR...";

          // --- KROK 3: Budowanie Sceny AR ---
          uruchomAR(znalezionePliki);
      }

      function uruchomAR(ilosc) {
          // Budujemy kod HTML sceny w pamici
          let html = `<a-scene mindar-image="imageTargetSrc: ${mindFile}; maxTrack: 1" color-space="sRGB" renderer="colorManagement: true, physicallyCorrectLights" vr-mode-ui="enabled: false" device-orientation-permission-ui="enabled: false">`;
          
          html += `<a-assets>`;
          for(let i=0; i < ilosc; i++) {
              html += `<video id="vid${i}" src="${folder}/${i}.mp4" loop="true" crossorigin="anonymous" playsinline webkit-playsinline muted autoplay></video>`;
          }
          html += `</a-assets>`;
          
          html += `<a-camera position="0 0 0" look-controls="enabled: false"></a-camera>`;

          for(let i=0; i < ilosc; i++) {
              html += `
              <a-entity mindar-image-target="targetIndex: ${i}" class="target-entity" data-id="${i}">
                  <a-plane src="#vid${i}" position="0 0 0" height="1" width="1" rotation="0 0 0"></a-plane>
              </a-entity>`;
          }
          html += `</a-scene>`;

          // Wstrzykujemy scen do strony
          document.getElementById('ar-container').innerHTML = html;

          // Ukrywamy loader, pokazujemy UI
          setTimeout(() => {
              document.getElementById('loader-screen').style.display = 'none';
              document.getElementById('ui-layer').style.display = 'flex';
              document.getElementById('websiteButton').style.display = 'flex';
              
              // Inicjujemy obsug zdarze (logika z poprzedniego kodu)
              initEvents();
          }, 1000); // Mae op贸藕nienie dla pewnoci
      }

      function initEvents() {
          const unmuteBtn = document.querySelector("#unmuteButton");
          const scanGuide = document.querySelector("#scan-guide");
          const scanText = document.querySelector("#scan-text");
          const targets = document.querySelectorAll('.target-entity');
              
          targets.forEach(target => {
            target.addEventListener("targetFound", event => {
              const id = target.getAttribute('data-id');
              const video = document.querySelector(`#vid${id}`);
              if(video) video.play();
              
              unmuteBtn.style.display = "block";
              scanGuide.style.opacity = "0";
              scanText.style.opacity = "0";
              scanGuide.style.transition = "opacity 0.8s ease-out";
              scanText.style.transition = "opacity 0.8s ease-out";
            });

            target.addEventListener("targetLost", event => {
              const id = target.getAttribute('data-id');
              const video = document.querySelector(`#vid${id}`);
              if(video) video.pause();
              
              unmuteBtn.style.display = "none";
              scanGuide.style.opacity = "1";
              scanText.style.opacity = "1";
            });
          });

          unmuteBtn.addEventListener("click", () => {
            document.querySelectorAll('video').forEach(v => { v.muted = false; v.volume = 1.0; });
            unmuteBtn.innerText = " Odtwarzanie...";
            unmuteBtn.style.background = "linear-gradient(135deg, #2ecc71 0%, #27ae60 100%)";
            unmuteBtn.style.color = "white";
            setTimeout(() => { unmuteBtn.style.opacity = "0"; setTimeout(() => { unmuteBtn.style.display = "none"; }, 500); }, 2500);
          });
      }

      // START
      wykryjPlikiIStartuj();

    </script>
  </body>
</html>
