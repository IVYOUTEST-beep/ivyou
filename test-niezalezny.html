<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IVYOU | Independent Engine Proto</title>
    <style>
        body { margin: 0; background: #000; overflow: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
        #status {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            color: #D4AF37; background: rgba(0,0,0,0.8); padding: 10px 20px;
            border: 1px solid #D4AF37; border-radius: 20px; font-family: sans-serif;
            font-weight: bold; z-index: 100;
        }
        video { display: none; } /* Ukrywamy surowe wideo, pokazujemy przetworzone na canvasie */
    </style>
</head>
<body>

    <div id="status">Ładowanie silnika OpenCV... (To może potrwać)</div>
    
    <video id="videoInput" playsinline webkit-playsinline></video>
    <img id="refImage" src="marker.jpg" style="display:none;" onload="startEngine()">

    <canvas id="canvasOutput"></canvas>

    <script async src="https://docs.opencv.org/4.5.0/opencv.js" onload="onOpenCvReady();" type="text/javascript"></script>

    <script>
        let video = document.getElementById('videoInput');
        let cap, refMat, frameMat, orb, matcher, statusDiv;
        let isCvLoaded = false;
        let isVideoReady = false;

        function onOpenCvReady() {
            isCvLoaded = true;
            statusDiv = document.getElementById('status');
            statusDiv.innerText = "Silnik gotowy. Uruchamiam kamerę...";
            startCamera();
        }

        function startCamera() {
            navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false })
                .then(function(stream) {
                    video.srcObject = stream;
                    video.play();
                    video.onloadedmetadata = () => {
                        isVideoReady = true;
                        statusDiv.innerText = "Szukam obrazu...";
                        processVideo();
                    };
                })
                .catch(function(err) {
                    statusDiv.innerText = "Błąd kamery: " + err;
                });
        }

        function startEngine() {
            // Czekamy aż OpenCV i Kamera będą gotowe
            if (!isCvLoaded) return;
        }

        function processVideo() {
            if (!isCvLoaded || !isVideoReady) return;

            // 1. Konfiguracja OpenCV
            cap = new cv.VideoCapture(video);
            frameMat = new cv.Mat(video.height, video.width, cv.CV_8UC4);
            refMat = cv.imread('refImage'); // Wczytujemy marker
            
            // Konwersja na odcienie szarości (szybciej działa)
            let refGray = new cv.Mat();
            let frameGray = new cv.Mat();
            cv.cvtColor(refMat, refGray, cv.COLOR_RGBA2GRAY);

            // 2. Detektor cech (ORB - szybki i darmowy)
            orb = new cv.ORB(500); // Szukamy 500 punktów charakterystycznych
            let keypointsRef = new cv.KeyPointVector();
            let descriptorsRef = new cv.Mat();
            orb.detectAndCompute(refGray, new cv.Mat(), keypointsRef, descriptorsRef);

            // Zmienne do pętli
            let keypointsFrame = new cv.KeyPointVector();
            let descriptorsFrame = new cv.Mat();
            matcher = new cv.BFMatcher(cv.NORM_HAMMING, true);
            
            const FPS = 30;
            
            // --- GŁÓWNA PĘTLA SILNIKA ---
            function loop() {
                try {
                    cap.read(frameMat);
                    cv.cvtColor(frameMat, frameGray, cv.COLOR_RGBA2GRAY);

                    // A. Znajdź punkty na obrazie z kamery
                    orb.detectAndCompute(frameGray, new cv.Mat(), keypointsFrame, descriptorsFrame);

                    // B. Porównaj z markerem
                    let matches = new cv.DMatchVector();
                    if (!descriptorsFrame.empty()) {
                        matcher.match(descriptorsRef, descriptorsFrame, matches);
                    }

                    // C. Filtrowanie dobrych dopasowań
                    let goodMatches = new cv.DMatchVector();
                    let minDistance = 50; 
                    for (let i = 0; i < matches.size(); i++) {
                        if (matches.get(i).distance <= minDistance) {
                            goodMatches.push_back(matches.get(i));
                        }
                    }

                    // D. Rysowanie wyników (DEBUGOWANIE)
                    let outputMat = new cv.Mat();
                    
                    // Jeśli znaleźliśmy dużo wspólnych punktów -> MAMY TO!
                    if (goodMatches.size() > 20) {
                        statusDiv.innerText = "✅ WYKRYTO OBRAZ! (" + goodMatches.size() + " pkt)";
                        statusDiv.style.color = "#00ff00";
                        statusDiv.style.borderColor = "#00ff00";
                        
                        // Tu narysowalibyśmy zieloną ramkę lub nałożyli wideo
                        cv.drawMatches(refGray, keypointsRef, frameGray, keypointsFrame, goodMatches, outputMat);
                    } else {
                        statusDiv.innerText = "Szukam... (" + goodMatches.size() + ")";
                        statusDiv.style.color = "#D4AF37";
                        statusDiv.style.borderColor = "#D4AF37";
                        cv.imshow('canvasOutput', frameMat); // Pokaż po prostu kamerę
                    }

                    if (goodMatches.size() > 20) {
                         cv.imshow('canvasOutput', outputMat); // Pokaż wizualizację dopasowań
                    }

                    // Czyszczenie pamięci (bardzo ważne w OpenCV!)
                    matches.delete();
                    goodMatches.delete();
                    outputMat.delete();

                    requestAnimationFrame(loop);
                } catch (err) {
                    console.error(err);
                }
            }

            // Start pętli
            loop();
        }
    </script>
</body>
</html>
